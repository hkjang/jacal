// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  USER
}

enum EventType {
  WORK
  PERSONAL
  MEETING
  APPOINTMENT
  OTHER
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  name          String
  passwordHash  String?
  timezone      String   @default("UTC")
  preferences   Json?
  isAdmin       Boolean  @default(false)
  role          UserRole @default(USER)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tasks         Task[]
  events        Event[]
  tags          Tag[]
  analytics     Analytics[]
  settings      UserSettings?
  webhookConfig WebhookConfig?
  connectedAccounts ConnectedAccount[]
  processedEmails ProcessedEmail[]
  habits        Habit[]
  teamMembers   TeamMember[]
  sharedEvents  SharedEvent[]
  comments      Comment[]
  
  @@map("users")
}

model ConnectedAccount {
  id            String   @id @default(uuid())
  userId        String
  provider      String   // google, outlook
  providerId    String   // ID from provider
  accessToken   String
  refreshToken  String?
  expiresAt     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@map("connected_accounts")
}

model Task {
  id                String   @id @default(uuid())
  userId            String
  title             String
  description       String?
  dueAt             DateTime?
  estimatedMinutes  Int?
  priority          Int      @default(0)
  status            String   @default("pending") // pending, in_progress, completed, cancelled
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tags              Tag[]    @relation("TaskTags")
  recurringRule     RecurringRule? @relation("TaskRecurringRule")
  // reminders removed - use polymorphic entityType/entityId pattern in Reminder model
  
  @@map("tasks")
}

model Event {
  id              String    @id @default(uuid())
  userId          String
  title           String
  description     String?
  startAt         DateTime
  endAt           DateTime
  location        String?
  eventType       EventType @default(OTHER)
  isAllDay        Boolean   @default(false)
  isFocusTime     Boolean   @default(false)
  sourceCalendar  String?   // google, outlook, caldav, manual
  externalId      String?   // ID from external calendar
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tags            Tag[]    @relation("EventTags")
  recurringRule   RecurringRule? @relation("EventRecurringRule")
  // reminders removed - use polymorphic entityType/entityId pattern in Reminder model
  
  @@map("events")
}

model RecurringRule {
  id          String   @id @default(uuid())
  taskId      String?  @unique
  eventId     String?  @unique
  rruleText   String   // iCal RRULE format
  createdAt   DateTime @default(now())

  task        Task?    @relation("TaskRecurringRule", fields: [taskId], references: [id], onDelete: Cascade)
  event       Event?   @relation("EventRecurringRule", fields: [eventId], references: [id], onDelete: Cascade)
  
  @@map("recurring_rules")
}

model Reminder {
  id          String   @id @default(uuid())
  entityType  String   // task or event
  entityId    String
  notifyAt    DateTime
  channel     String   // push, email, sms
  sent        Boolean  @default(false)
  createdAt   DateTime @default(now())

  // Note: task and event relations removed to support polymorphic association
  // The entityId field can reference either tasks.id or events.id based on entityType
  
  @@map("reminders")
}

model Tag {
  id        String   @id @default(uuid())
  userId    String
  name      String
  color     String?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tasks     Task[]   @relation("TaskTags")
  events    Event[]  @relation("EventTags")
  
  @@unique([userId, name])
  @@map("tags")
}

model Analytics {
  id              String   @id @default(uuid())
  userId          String
  date            DateTime @db.Date
  focusMinutes    Int      @default(0)
  meetingMinutes  Int      @default(0)
  tasksCompleted  Int      @default(0)
  tasksPlanned    Int      @default(0)
  eventsAttended  Int      @default(0)
  productivityScore Float  @default(0)
  createdAt       DateTime @default(now())

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, date])
  @@map("analytics")
}

model UserSettings {
  id              String   @id @default(uuid())
  userId          String   @unique
  ollamaEnabled   Boolean  @default(false)
  ollamaBaseUrl   String?
  ollamaModel     String?
  pop3Enabled     Boolean  @default(false)
  pop3Host        String?
  pop3Port        Int?
  pop3User        String?
  pop3Password    String?
  pop3Tls         Boolean  @default(true)
  savedLocations  Json?    // Array of saved location strings
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("user_settings")
}

model WebhookConfig {
  id              String   @id @default(uuid())
  userId          String   @unique
  enabled         Boolean  @default(false)
  url             String?
  columnMapping   Json?    // JSON object for column mapping
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("webhook_configs")
}

model ProcessedEmail {
  id        String   @id @default(uuid())
  userId    String
  uidl      String
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, uidl])
  @@map("processed_emails")
}

model Habit {
  id          String   @id @default(uuid())
  userId      String
  title       String
  description String?
  frequency   String   // daily, weekly, custom
  targetDays  Int      @default(7) // days per week for weekly habits
  color       String?
  icon        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs        HabitLog[]

  @@map("habits")
}

model HabitLog {
  id          String   @id @default(uuid())
  habitId     String
  userId      String
  completedAt DateTime @default(now())
  note        String?

  habit       Habit    @relation(fields: [habitId], references: [id], onDelete: Cascade)

  @@map("habit_logs")
}

model Team {
  id          String   @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members     TeamMember[]
  events      SharedEvent[]

  @@map("teams")
}

enum TeamRole {
  OWNER
  ADMIN
  MEMBER
}

model TeamMember {
  id        String   @id @default(uuid())
  teamId    String
  userId    String
  role      TeamRole @default(MEMBER)
  joinedAt  DateTime @default(now())

  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@map("team_members")
}

model SharedEvent {
  id          String   @id @default(uuid())
  teamId      String
  title       String
  description String?
  startAt     DateTime
  endAt       DateTime
  location    String?
  authorId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  team        Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  comments    Comment[]

  @@map("shared_events")
}

model Comment {
  id            String   @id @default(uuid())
  sharedEventId String
  userId        String
  content       String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sharedEvent   SharedEvent @relation(fields: [sharedEventId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("comments")
}

// Admin-related models
model AppSettings {
  id                       String   @id @default(uuid())
  siteName                 String   @default("Jacal")
  siteUrl                  String   @default("http://localhost:5173")
  defaultLanguage          String   @default("ko")
  timezone                 String   @default("Asia/Seoul")
  allowRegistration        Boolean  @default(true)
  requireEmailVerification Boolean  @default(false)
  maxUploadSizeMB          Int      @default(10)
  updatedAt                DateTime @updatedAt

  @@map("app_settings")
}

model Webhook {
  id        String   @id @default(uuid())
  name      String
  url       String
  events    String[]
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("webhooks")
}

model Integration {
  id        String   @id @default(uuid())
  name      String   @unique
  type      String?
  provider  String?
  apiKey    String?
  config    Json
  active    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("integrations")
}

model EmailSettings {
  id           String   @id @default(uuid())
  smtpHost     String
  smtpPort     Int
  smtpUser     String
  smtpPassword String
  smtpSecure   Boolean  @default(false)
  fromName     String
  fromEmail    String
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("email_settings")
}

model BackupRecord {
  id        String   @id @default(uuid())
  filename  String
  size      BigInt
  status    String   @default("success")
  createdAt DateTime @default(now())

  @@map("backup_records")
}

// 관리자가 설정하는 알림용 웹훅 (모든 사용자의 알림에 대해 트리거)
model NotificationWebhook {
  id          String   @id @default(uuid())
  name        String   // 예: "Slack 알림", "Discord Bot"
  url         String
  active      Boolean  @default(true)
  headers     Json?    // 커스텀 헤더 (Authorization 등)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  logs        NotificationWebhookLog[]

  @@map("notification_webhooks")
}

// 웹훅 호출 로그
model NotificationWebhookLog {
  id          String   @id @default(uuid())
  webhookId   String
  reminderId  String
  status      String   // "pending", "success", "failed"
  statusCode  Int?     // HTTP 응답 코드
  response    String?  // 응답 본문 (에러시)
  sentAt      DateTime?
  createdAt   DateTime @default(now())

  webhook     NotificationWebhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@map("notification_webhook_logs")
}
